## План внедрения per-user B2 через серверный ключ (способ 1)

1) Хранение B2-кредов
- Firestore: `users/{uid}/settings/b2` со структурой: `payload` (зашифрованный JSON `{ keyId, applicationKey, bucketId, bucketName, endpoint? }`), `createdAt/updatedAt`.
- Шифрование/дешифрование на сервере одним мастер-ключом из приватного env (`B2_MASTER_SECRET`), AES-GCM; `payload` в base64 (nonce + ciphertext + tag). Мастер-ключ недоступен клиенту/бандлу.

2) UI для ввода/редактирования
- Страница Settings: форма ввода B2 (keyId, applicationKey, bucketId, bucketName, endpoint).
- Кнопки: “Сохранить” (POST на сервер), опционально “Проверить” (сервер вызывает `b2_authorize_account`).
- Показ состояния: сохранено/ошибка; без повторной выдачи секретов (только факт наличия).

3) Серверные эндпоинты (с проверкой userId через ID-токен)
- `GET /api/user/b2` → `{ exists: boolean }` (без раскрытия ключей).
- `POST /api/user/b2` → принимает креды, шифрует, сохраняет.
- (Опционально) `POST /api/user/b2/test` → проверка коннекта без сохранения.
- TODO: добавить проверку Firebase ID token (уйти от доверия к `userId` из тела/квери).

4) Интеграция в текущие маршруты
- `/api/b2/upload-url`, `/api/b2/file` вместо env читают креды пользователя: достать `users/{uid}/settings/b2`, расшифровать, использовать `keyId/applicationKey/bucketId/bucketName` для вызовов B2. Ошибка 400/404, если кредов нет; 500 при сбое расшифровки.
- (Опционально) fallback на глобальные env `BLACKBAZE_*` для single-user режима, но цель — per-user.

5) Авторизация
- Все серверные маршруты, использующие креды, должны валидировать Firebase ID token (userId вытягиваем сервером, не доверяем полям тела).

6) UX/гейт
- При загрузке `/upload`/`/` проверять наличие B2 настроек (`GET /api/user/b2`). Если нет — блокировать загрузку/отдачу с сообщением “добавьте B2 креды в Settings”.
- При вводе и сохранении кредов — не возвращать их обратно в клиент; только статус.

7) Безопасность
- Мастер-ключ только в env на сервере (Netlify env); не экспортировать в клиент.
- Не хранить/показывать креды в UI после ввода; не писать в localStorage; не логировать.
- Всё шифрование/дешифрование только на сервере.
